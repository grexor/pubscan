<html>

<head>
    <title>pubScan, your publication network scanner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="pubscan.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div class="relative" style="width: 250px;">
        <input value="Gregor Rot" type="text" id="query" placeholder="Search..." class="w-full text-sm border rounded-full shadow-md px-3 focus:outline-none focus:border-gray-500" style="height: 30px; padding-top: 0; padding-bottom: 0;">
        <button id="searchButton" class="absolute right-2 top-0 bottom-0 flex items-center text-gray-500 hover:text-blue-600">            üîç
        </button>
    </div>    

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50" onclick="closeModal()">
        <!-- Modal Content -->
        <div class="bg-white p-6 rounded-lg shadow-lg w-3/4 h-3/4 relative z-50" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Streaming Data</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <pre id="jsonOutput" class="bg-gray-200 p-3 rounded-md text-sm max-h-[60vh] overflow-auto"></pre>
            <div class="flex justify-end mt-4">
                <button onclick="clearJson()" class="px-4 py-2 bg-gray-500 text-white rounded-md mr-2">Clear</button>
                <button onclick="closeModal()" class="px-4 py-2 bg-red-500 text-white rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="output">Output</div>

    <a href="javascript:openModal()">stream</a>
    <div id="mynetwork"></div>
    <div id="div_bottom">@grexor</div>

    <script>


        function openModal() {
            const modal = document.getElementById("modal");
            modal.classList.remove("hidden");
            modal.classList.add("flex"); // Ensure it's visible
        }

        function closeModal() {
            const modal = document.getElementById("modal");
            modal.classList.add("hidden");
        }

        function clearJson() {
            document.getElementById("jsonOutput").textContent = "";
        }

        function updateModalContent(data) {
            const jsonOutput = document.getElementById("jsonOutput");
            jsonOutput.textContent += data + "\n";
            jsonOutput.scrollTop = jsonOutput.scrollHeight;
        }

        function stream_test() {

	// fetch instead of ajax

            fetch("https://pubscan.expressrna.org/gw/index.py?action=stream_test&streaming=1")
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const outputElement = document.getElementById("output");

        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    console.log("Stream finished.");
                    return;  // ‚úÖ Properly close the stream
                }
                outputElement.innerText += decoder.decode(value);  // ‚úÖ Append data
                return readStream();  // Keep reading next chunks
            });
        }

        return readStream();
    })
    .catch(error => console.error("Error:", error));


        }

        document.getElementById("query").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {  // Detect "Enter" key
                event.preventDefault();   // Prevent form submission (if inside a form)
                document.getElementById("searchButton").click(); // Trigger button click
            }
        });

        document.getElementById("searchButton").addEventListener("click", function() {
            query = document.getElementById("query").value;
            get_author_network(query);
        });
    </script>

    <script type="text/javascript">
      
    var my_network;
  
    let nodes_all = [
    ];

    let edges_all = [
    ];

    function draw() {
        var container = document.getElementById("mynetwork");
        var data = {
          nodes: nodes_all,
          edges: edges_all,
        };
        var options = {
          groups : {
        'g0': { color: {background:'#FFB26F', highlight: { background: '#FFB26F'} } },
        'g1': { color: {background:'#789DBC', highlight: { background: '#789DBC'} } },
        'g2': { color: {background:'#CEDF9F', highlight: { background: '#CEDF9F'} } },
        'g3': { color: {background:'#CB80AB', highlight: { background: '#CB80AB'} } },
        'g4': { color: {background:'#D37676', highlight: { background: '#D37676'} } },
        'g5': { color: {background:'#A37676', highlight: { background: '#A37676'} } },
        'g6': { color: {background:'#B37676', highlight: { background: '#B37676'} } },
        'g7': { color: {background:'#C37676', highlight: { background: '#C37676'} } },
        'g8': { color: {background:'#D37676', highlight: { background: '#D37676'} } },
        },
          nodes: {
            shape: "dot",
            size: 18,
                font: {
                    size: 30, // Adjust the font size here
                    color: '#343434',
                    face: 'arial',
                },            
          },
          edges: {
            font: {
              size: 20,
              face: 'arial',
              color: '#a1a1a1',
            },
          },
          layout: {
            improvedLayout: false,
          },
          physics: {
            barnesHut: {
                gravitationalConstant: -4000, // Strength of attraction (-ve pulls nodes together)
                centralGravity: 0.3,         // Pull towards center
                springLength: 200,            // Edge length
                springConstant: 0.01,        // Strength of spring force
                damping: 0.1,               // Slow down movement over time
                avoidOverlap: 1              // Avoid node overlap (0 = disabled)
            },
            forceAtlas2Based: {
              gravitationalConstant: -50,
              centralGravity: 0.001,
              //springLength: 100,
              springConstant: 0.08, // really influences jiggling
              damping: 0.4,
              avoidOverlap: 1,
            },
            maxVelocity: 50,
            solver: "forceAtlas2Based",
            timestep: 0.5,
            adaptiveTimestep: true,
            stabilization: { iterations: 1000 },
          },
        };

        let my_network = new vis.Network(container, data, options);

        globalThis.my_network = my_network;

        //setTimeout(function () {
        //    globalThis.my_network.setOptions({ physics: { solver: "barnesHut", timestep: 0.1 } }); // Slow down physics
        //}, 2000);

        //setTimeout(function () {
        //    globalThis.my_network.setOptions({ physics: false }); // Fully disable physics after 4 seconds
        //}, 4000);

      }
    </script>

    </script>

    <script>
        function pmids_download() {
            $.ajax({
                url: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?term=Gregor Rot[Author]&retmax=200&retmode=json",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    pmids = data["esearchresult"]["idlist"];
                    for (let i = 0; i < pmids.length; i++) {
                        console.log(pmids[i]);
                    }
                    $("#output").text(JSON.stringify(data, null, 2));
                    nodes_all = [
                        { id: 'Gregor Rot', label: 'Gregor Rot', group: 'g1', size: 20 },
                        { id: 'Johannes Hartl', label: 'Johannes Hartl', group: 'g2', size: 20 },
                        { id: 'Florian Hubrich', label: 'Florian Hubrich', group: 'g4', size: 20 },
                    ];
                    draw();
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        };

        function get_author_network(query) {
            let encodedQuery = encodeURIComponent(query);

            fetch("https://pubscan.expressrna.org/gw/index.py?action=get_author_network&author=" + encodedQuery + "&response_type=json").then(response =>
            {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";

                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log("Stream finished.");
                            return;
                        }

                        buffer += decoder.decode(value, { stream: true });

                        // Process each complete JSON object (assuming newline-delimited JSON)
                        let parts = buffer.split("\n");  
                        buffer = parts.pop();  // Keep the last incomplete part in buffer

                        for (const part of parts) {
                            try {
                                const mydata = JSON.parse(part);
                                console.log("Received JSON data:", mydata);
                                if (mydata["instruction"]=="data") {
                                    nodes_all = mydata["nodes_all"];
                                    edges_all = mydata["edges_all"];
                                    draw();
                                }
                                if (mydata["instruction"]=="show") {
                                    openModal();
                                    updateModalContent(mydata["data"]);
                                }

                            } catch (error) {
                                console.error("Error parsing JSON:", error);
                            }
                        }

                        return readStream(); // Continue reading next chunks
                    });
                }
                
                return readStream();
            })
            .catch(error => console.error("Error:", error));

        }

        function get_author_network_old(query) {
            $.ajax({
                url: "https://pubscan.expressrna.org/gw/index.py?action=get_author_network&author=" + encodedQuery + "&response_type=not_json",
                type: "GET",
                //dataType: "json",
                success: function(data) {
                    console.log(data);
                    mydata = data;
                    if (mydata["instruction"]=="data") {
                        console.log(mydata["instruction"]);
                        nodes_all = mydata["nodes_all"];
                        edges_all = mydata["edges_all"];
                        //$("#output").text(JSON.stringify(data, null, 2));
                        draw();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        }


    </script>

    </body>
</html>
