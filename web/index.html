<html>

<head>
    <title>pubScan, your publication network scanner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="pubscan.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0X1YQBFGS"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-G0X1YQBFGS');
</script>

<body>
    <div style="background-color:cornflowerblue; padding-left: 10px;"><div style="color:aliceblue; font-size: 15px;">pubScan v0.1; discover your co-authors network</div></div>
    <div style="background-color:rgb(226, 234, 255); padding-left: 10px; padding-top: 5px; padding-bottom: 5px; display: flex">

        <div class="relative" style="width: 200px; display: flex">
            <input value="Gregor Rot" type="text" id="query" placeholder="Search..." class="w-full text-sm border rounded-full shadow-md px-3 focus:outline-none focus:border-gray-500" style="height: 25px; padding-top: 0; padding-bottom: 0;">
            <button id="searchButton" class="absolute right-2 top-0 bottom-0 flex items-center text-gray-500 hover:text-blue-600">            üîç
            </button>
        </div>
        <div style="display: flex; padding-left: 10px;">
            <a href="javascript:globalThis.my_network.fit();">Center</a>
        </div>
        <div style="display: flex; padding-left: 10px;">
            <a href="javascript:color_node('Gregor Rot', 'red');">Color</a>
        </div>
    </div>


    <!-- Modal -->
    <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50" onclick="closeModal()">
        <!-- Modal Content -->
        <div class="bg-white p-6 rounded-lg shadow-lg w-3/4 h-3/4 relative z-50" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Streaming Data</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <pre id="jsonOutput" class="bg-gray-200 p-3 rounded-md text-sm max-h-[60vh] overflow-auto"></pre>
            <div class="flex justify-end mt-4">
                <button onclick="clearJson()" class="px-4 py-2 bg-gray-500 text-white rounded-md mr-2">Clear</button>
                <button onclick="closeModal()" class="px-4 py-2 bg-red-500 text-white rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="mynetwork"></div>
    <div id="info">some information</div>
    <div id="div_bottom"><a href="https://grexor.github.io">Developed by Gregor Rot, @grexor</a></div>

    <script>

        function color_node(nodeId, newColor) {
            nodes_dataset.update({ id: nodeId, color: newColor });
        }

        function openModal() {
            const modal = document.getElementById("modal");
            modal.classList.remove("hidden");
            modal.classList.add("flex"); // Ensure it's visible
        }

        function closeModal() {
            const modal = document.getElementById("modal");
            modal.classList.add("hidden");
        }

        function clearJson() {
            document.getElementById("jsonOutput").textContent = "";
        }

        function updateModalContent(data) {
            const jsonOutput = document.getElementById("jsonOutput");
            jsonOutput.textContent += data + "\n";
            jsonOutput.scrollTop = jsonOutput.scrollHeight;
        }

        function stream_test() {

	// fetch instead of ajax

            fetch("https://pubscan.expressrna.org/gw/index.py?action=stream_test&streaming=1")
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const outputElement = document.getElementById("output");

        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    console.log("Stream finished.");
                    return;  // ‚úÖ Properly close the stream
                }
                outputElement.innerText += decoder.decode(value);  // ‚úÖ Append data
                return readStream();  // Keep reading next chunks
            });
        }

        return readStream();
    })
    .catch(error => console.error("Error:", error));


        }

        document.getElementById("query").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {  // Detect "Enter" key
                event.preventDefault();   // Prevent form submission (if inside a form)
                document.getElementById("searchButton").click(); // Trigger button click
            }
        });

        document.getElementById("searchButton").addEventListener("click", function() {
            query = document.getElementById("query").value;
            get_author_network(query);
        });
    </script>

    <script type="text/javascript">
      
    var my_network;
  
    let current_center = "";

    let nodes_all = [
    ];

    let nodes_dataset = [
    ];

    let edges_all = [
    ];

    let edges_dataset = [
    ];

    function draw() {
        var container = document.getElementById("mynetwork");

        if (globalThis.my_network) {
            globalThis.my_network.destroy();
            globalThis.my_network = null;
        }

        nodes_dataset = new vis.DataSet(nodes_all);
        edges_dataset = new vis.DataSet(edges_all);
        var data = {
          nodes: nodes_dataset,
          edges: edges_dataset,
        };
        var options = {
            autoResize: true,
            height: '100%',
            width: '100%',            
          groups : {
        'g0': { color: {background:'#EBF2F6', highlight: { background: '#EBF2F6'} } },
        'g1': { color: {background:'#C6D6E2', highlight: { background: '#C6D6E2'} } },
        'g2': { color: {background:'#93AEC5', highlight: { background: '#93AEC5'} } },
        'g3': { color: {background:'#293D4D', highlight: { background: '#293D4D'} } },
        'g4': { color: {background:'#CCEEFA', highlight: { background: '#C3EEFA'} } },
        'g5': { color: {background:'#FFEEFA', highlight: { background: '#C3EEFA'} } },
        'g6': { color: {background:'#B37676', highlight: { background: '#B37676'} } },
        'g7': { color: {background:'#C37676', highlight: { background: '#C37676'} } },
        'g8': { color: {background:'#D37676', highlight: { background: '#D37676'} } },
        },
        interaction: {
            zoomSpeed: 0.1,  // Slow down zooming (default is 1)
            navigationButtons: true  // Optionally add navigation buttons (optional)
        },        
        nodes: {
            shape: "dot",
            size: 18,
                font: {
                    size: 30, // Adjust the font size here
                    color: '#343434',
                    face: 'arial',
                },            
          },
          edges: {
            color: '#ff0000',
            font: {
              size: 20,
              face: 'arial',
              color: '#a1a1a1',
            },
            //selectionWidth: 1,
          },
          layout: {
            improvedLayout: true,
            randomSeed: 42,
          },
          physics: {
            stabilization: {
                enabled: true,
                iterations: 200,
                updateInterval: 20,
                fit: true,
            },
            barnesHut: {
                gravitationalConstant: -4000, // Strength of attraction (-ve pulls nodes together)
                centralGravity: 0.3,         // Pull towards center
                springLength: 200,            // Edge length
                springConstant: 0.01,        // Strength of spring force
                damping: 0.1,               // Slow down movement over time
                avoidOverlap: 1              // Avoid node overlap (0 = disabled)
            },
            forceAtlas2Based: {
              gravitationalConstant: -20,
              centralGravity: 0.001,
              springConstant: 0.03, // how much attraction between nodes
              damping: 0.9,
              avoidOverlap: 1,
            },
            maxVelocity: 100,
            solver: "forceAtlas2Based",
            timestep: 0.3,
            adaptiveTimestep: true,
          },
        };

        let my_network = new vis.Network(container, data, options);

        globalThis.my_network = my_network;
        globalThis.my_network.on("doubleClick", function (params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            onNodeDoubleClick(nodeId);
        }
        });
        color_node(current_center, 'red');


        //globalThis.my_network.on('stabilizationIterationsDone', function () {
        //network.setOptions({
        //    physics: {
        //    enabled: false
        //    }
        //});
        //});        


        //globalThis.my_network.fit();
        //globalThis.my_network.clustering.clusterByHubsize();

        //setTimeout(function () {
        //    globalThis.my_network.setOptions({ physics: { solver: "barnesHut", timestep: 0.1 } }); // Slow down physics
        //}, 2000);

        //setTimeout(function () {
        //    globalThis.my_network.setOptions({ physics: false }); // Fully disable physics after 4 seconds
        //}, 4000);

      }
    </script>

    </script>

    <script>
        function pmids_download() {
            $.ajax({
                url: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?term=Gregor Rot[Author]&retmax=200&retmode=json",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    pmids = data["esearchresult"]["idlist"];
                    for (let i = 0; i < pmids.length; i++) {
                        console.log(pmids[i]);
                    }
                    $("#output").text(JSON.stringify(data, null, 2));
                    nodes_all = [
                        { id: 'Gregor Rot', label: 'Gregor Rot', group: 'g1', size: 20 },
                        { id: 'Johannes Hartl', label: 'Johannes Hartl', group: 'g2', size: 20 },
                        { id: 'Florian Hubrich', label: 'Florian Hubrich', group: 'g4', size: 20 },
                    ];
                    draw();
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        };

        function get_author_network(query) {
            let encodedQuery = encodeURIComponent(query);
            current_center = query.toLowerCase();
            const datetime = new Date().toISOString();

            fetch("https://pubscan.expressrna.org/gw/index.py?action=get_author_network_mysql&author=" + encodedQuery + "&response_type=json&datetime=" + datetime).then(response =>
            {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";

                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log("Stream finished.");
                            return;
                        }

                        buffer += decoder.decode(value, { stream: true });

                        // Process each complete JSON object (assuming newline-delimited JSON)
                        let parts = buffer.split("\n");  
                        buffer = parts.pop();  // Keep the last incomplete part in buffer

                        for (const part of parts) {
                            try {
                                const mydata = JSON.parse(part);
                                console.log("Received JSON data:", mydata);
                                if (mydata["instruction"]=="data") {
                                    nodes_all = mydata["nodes_all"];
                                    edges_all = mydata["edges_all"];
                                    console.log(edges_all);
                                    draw();
                                }
                                if (mydata["instruction"]=="show") {
                                    //openModal();
                                    updateModalContent(mydata["data"]);
                                }

                            } catch (error) {
                                console.error("Error parsing JSON:", error);
                            }
                        }

                        return readStream(); // Continue reading next chunks
                    });
                }
                
                return readStream();
            })
            .catch(error => console.error("Error:", error));

        }

    function onNodeDoubleClick(nodeId) {
        console.log("Double-clicked node ID:", nodeId);
        get_author_network(nodeId);
    }        

    </script>

    </body>
</html>
